"use strict";!function(){let t,e,n,r,o={draw:0,win:0,lose:0},s,i,c;var a,u;function l(){for(let t=0;t<e.length;t++)e[t].setAttribute("disabled","disabled")}function g(){for(let t=0;t<e.length;t++)e[t].removeAttribute("disabled")}function f(t){n.innerHTML=t}function d(t){r.innerHTML=["<h2>"+t+"</h2>","Won: "+o.win,"Lost: "+o.lose,"Draw: "+o.draw].join("<br>")}function m(){t.on("start",(t,e)=>{a=t,i=e,console.log(a,i),g(),f("Game Start!"),c.start()});t.on("turn",(t,e)=>{a=t,u=e,console.log("turn",i,u),g(),f("Your turn!")});t.on("wait",t=>{a=t,u=[],console.log("wait",i,u),l(),f("Opponents turn!")});t.on("win",()=>{o.win++,d("You win!")});t.on("lose",()=>{o.lose++,d("You lose!")});t.on("draw",()=>{o.draw++,d("Draw!")});t.on("end",()=>{l(),f("Waiting for opponent...")});t.on("connect",()=>{l(),f("Waiting for opponent...")});t.on("disconnect",()=>{l(),f("Connection lost!")});t.on("error",()=>{l(),f("Connection error!")})}function w(){t=io({upgrade:!1,transports:["websocket"]});e=document.getElementsByTagName("button");n=document.getElementById("message");r=document.getElementById("score");s=document.getElementById("game");c=p(640,320,s);a=void 0;l();m()}window.addEventListener("load",w,!1);function p(t,e,n){let r=new I(t,e,n),o=new L(t,e);r.setStage(o);r.setStageTransition(()=>{if(r.stage instanceof L){let n=new B(t,e);r.setStage(n)}});return r}class h{constructor(t,e){this.x=t;this.y=e}}function x(t,e){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}function y(t,e){let n=t.getBoundingClientRect();return new h(e.clientX-n.left,e.clientY-n.top)}function b(t,e){let n=t.getBoundingClientRect();return new h(e.touches[0].clientX-n.left,e.touches[0].clientY-n.top)}class C{constructor(){if(C.instance){return C.instance}this.numOfImages=0;this.numComplete=0;this.images={};C.instance=this}loadImage(t,e){this.numOfImages++;let n=new Image;n.onload=()=>{C.instance.images[t]=n,C.instance.numComplete++};n.src=e}getImage(t){let e=this.images[t];if(e instanceof Image){return e}throw new Error(t+' is not a valid key')}getProgress(){return this.numComplete/this.numOfImages}loadingIsCompleted(){if(this.numOfImages===0){return!0}return this.getProgress()===1}}class I{constructor(t,e,n){this.w=t;this.h=e;this.canvas=n;this.canvas.width=this.w;this.canvas.height=this.h;this.ctx=this.canvas.getContext('2d');this.stage=void 0}setStage(t){this.stage=t;this.stage.ctx=this.ctx;this.stage.init()}setStageTransition(t){this.transitionFun=t}start(){this.running=!0;let t=this;function e(){let n=Date.now(),r=n-t.currentTime;t.currentTime=n;t.running&&t.update(r/1e3);t.render();window.requestAnimationFrame(e)}window.requestAnimationFrame(e)}stop(){this.running=!1}update(t){this.stage.finished&&this.transitionFun!==void 0&&this.transitionFun();this.stage!==void 0&&this.stage.update(t)}render(){this.ctx.save();this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);this.ctx.restore();this.stage!==void 0&&this.stage.render()}}class v{constructor(t,e){this.w=t;this.h=e;this.ctx=void 0;this.finished=!1;this.actors=[]}addActor(t){t.stage=this;t.init();this.actors.push(t)}init(){this.finished=!1}update(t){this.actors=this.actors.filter(t=>!t.remove);this.sortActorsByLayer();for(let e of this.actors)e.update(t)}render(){for(let t of this.actors)t.render()}sortActorsByLayer(){this.actors.sort((t,e)=>{return t.layer-e.layer})}}class L extends v{constructor(t,e){super(t,e);this.assetLoader=new C;this.progress=this.assetLoader.getProgress()}update(t){super.update(t);this.progress=this.assetLoader.getProgress();this.assetLoader.loadingIsCompleted()&&(this.finished=!0)}render(){super.render();this.ctx.save();this.drawProgress();this.ctx.restore()}drawProgress(){let t=20,e=this.w-t*2,n=50,r=e*this.progress;this.ctx.strokeRect(t,this.h/2-n/2,e,n);this.ctx.fillRect(t,this.h/2-n/2,r,n)}}class P{constructor(t,e){this.pos=t;this.layer=e.layer?e.layer:0;this.stage=e.stage?e.stage:void 0;this.debugColour=e.debugColour?e.debugColour:'#000000';this.remove=!1}init(){}update(t){}render(){this.debugDraw()}debugDraw(){}}class A extends P{constructor(t,e,n){super(t,n);this.r=e}debugDraw(){let t=this.stage.ctx;t.beginPath();t.fillStyle=this.debugColour;t.arc(this.pos.x,this.pos.y,this.r,0,2*Math.PI);t.fill()}}class B extends v{constructor(t,e){super(t,e);this.mesh=[]}init(){super.init();for(let t=0;t<a.r;t++){for(let e=0;e<a.c;e++){if(a.tiles[t][e]===null){continue}let n=a.tiles[t][e],r=n.c*50+30+20*(t%2),o=n.r*50+30;this.addActor(new S(new h(r,o),n))}}s.addEventListener("mousedown",e=>{let n=y(s,e),r=this.actors.filter(t=>t instanceof S).filter(t=>t.doesIntersect(n));if(r[0]!==void 0){let e=r[0].tile;t.emit("move",{r:e.r,c:e.c})}});s.addEventListener("touchstart",e=>{let n=b(s,e),r=this.actors.filter(t=>t instanceof S).filter(t=>t.doesIntersect(n));if(r[0]!==void 0){let e=r[0].tile;t.emit("move",{r:e.r,c:e.c})}});for(let t=0;t<a.r;t++){for(let e=0;e<a.c;e++){if(a.tiles[t][e]===null){continue}let n=a.tiles[t][e],r=new BoardTile(n.r,n.c);r.getSiblings().filter(t=>a.tiles[t.r]!==void 0).map(t=>a.tiles[t.r][t.c]).filter(t=>t).forEach(e=>{let r=n.c*50+30+20*(t%2),o=n.r*50+30,s=e.c*50+30+20*(e.r%2),i=e.r*50+30;this.mesh.push({from:new h(r,o),to:new h(s,i)})})}}}update(t){super.update(t)}render(){let t=this.ctx;for(let e of this.mesh){let n=e.from,r=e.to;t.strokeStyle="#000000";t.lineWidth=2;t.beginPath();t.moveTo(n.x,n.y);t.lineTo(r.x,r.y);t.stroke()}super.render()}}class S extends A{constructor(t,e){super(t,20,{layer:e.y});this.tile=e;this.accum=0}doesIntersect(t){return x(t,this.pos)<this.r}update(t){this.accum=(this.accum+t)%Math.PI}render(){this.tile=a.tiles[this.tile.r][this.tile.c];let t=this.stage.ctx;this.tile.owner===i?(this.debugColour="#0000FF"):this.tile.owner!==void 0?(this.debugColour="#FF0000"):(this.debugColour="#000000");super.render();u.filter(t=>t.r===this.tile.r&&t.c===this.tile.c).length>0&&(t.strokeStyle="#777777",t.lineWidth=5,t.globalAlpha=1-Math.sin(this.accum)/2,t.beginPath(),t.arc(this.pos.x,this.pos.y,this.r-3,0,2*Math.PI),t.stroke(),t.globalAlpha=1)}}}()