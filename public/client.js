"use strict";!function(){let t,n,e,o,r={draw:0,win:0,lose:0},s,i,a;var c;function u(t){c=t}function g(){for(let t=0;t<n.length;t++)n[t].setAttribute("disabled","disabled")}function d(){for(let t=0;t<n.length;t++)n[t].removeAttribute("disabled")}function l(t){e.innerHTML=t}function f(t){o.innerHTML=["<h2>"+t+"</h2>","Won: "+r.win,"Lost: "+r.lose,"Draw: "+r.draw].join("<br>")}function w(){t.on("start",(t,n)=>{u(t),i=n,console.log(c,i),d(),l("Game Start!"),a.start()});t.on("turn",t=>{u(t),console.log("turn",t,i),d(),l("Your turn!")});t.on("wait",t=>{u(t),console.log("wait",t,i),g(),l("Opponents turn!")});t.on("win",()=>{r.win++,f("You win!")});t.on("lose",()=>{r.lose++,f("You lose!")});t.on("draw",()=>{r.draw++,f("Draw!")});t.on("end",()=>{g(),l("Waiting for opponent...")});t.on("connect",()=>{g(),l("Waiting for opponent...")});t.on("disconnect",()=>{g(),l("Connection lost!")});t.on("error",()=>{g(),l("Connection error!")})}function m(){t=io({upgrade:!1,transports:["websocket"]});n=document.getElementsByTagName("button");e=document.getElementById("message");o=document.getElementById("score");s=document.getElementById("game");a=p(640,320,s);c=void 0;g();w()}window.addEventListener("load",m,!1);function p(t,n,e){let o=new C(t,n,e),r=new I(t,n);o.setStage(r);o.setStageTransition(()=>{if(o.stage instanceof I){let e=new A(t,n);o.setStage(e)}});return o}class h{constructor(t,n){this.x=t;this.y=n}}function y(t,n){return Math.sqrt(Math.pow(n.x-t.x,2)+Math.pow(n.y-t.y,2))}function b(t,n){let e=t.getBoundingClientRect();return new h(n.clientX-e.left,n.clientY-e.top)}class x{constructor(){if(x.instance){return x.instance}this.numOfImages=0;this.numComplete=0;this.images={};x.instance=this}loadImage(t,n){this.numOfImages++;let e=new Image;e.onload=()=>{x.instance.images[t]=e,x.instance.numComplete++};e.src=n}getImage(t){let n=this.images[t];if(n instanceof Image){return n}throw new Error(t+' is not a valid key')}getProgress(){return this.numComplete/this.numOfImages}loadingIsCompleted(){if(this.numOfImages===0){return!0}return this.getProgress()===1}}class C{constructor(t,n,e){this.w=t;this.h=n;this.canvas=e;this.canvas.width=this.w;this.canvas.height=this.h;this.ctx=this.canvas.getContext('2d');this.stage=void 0}setStage(t){this.stage=t;this.stage.ctx=this.ctx;this.stage.init()}setStageTransition(t){this.transitionFun=t}start(){this.running=!0;let t=this;function n(){let e=Date.now(),o=e-t.currentTime;t.currentTime=e;t.running&&t.update(o/1e3);t.render();window.requestAnimationFrame(n)}window.requestAnimationFrame(n)}stop(){this.running=!1}update(t){this.stage.finished&&this.transitionFun!==void 0&&this.transitionFun();this.stage!==void 0&&this.stage.update(t)}render(){this.ctx.save();this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);this.ctx.restore();this.stage!==void 0&&this.stage.render()}}class v{constructor(t,n){this.w=t;this.h=n;this.ctx=void 0;this.finished=!1;this.actors=[]}addActor(t){t.stage=this;t.init();this.actors.push(t)}init(){this.finished=!1}update(t){this.actors=this.actors.filter(t=>!t.remove);this.sortActorsByLayer();for(let n of this.actors)n.update(t)}render(){for(let t of this.actors)t.render()}sortActorsByLayer(){this.actors.sort((t,n)=>{return t.layer-n.layer})}}class I extends v{constructor(t,n){super(t,n);this.assetLoader=new x;this.progress=this.assetLoader.getProgress()}update(t){super.update(t);this.progress=this.assetLoader.getProgress();this.assetLoader.loadingIsCompleted()&&(this.finished=!0)}render(){super.render();this.ctx.save();this.drawProgress();this.ctx.restore()}drawProgress(){let t=20,n=this.w-t*2,e=50,o=n*this.progress;this.ctx.strokeRect(t,this.h/2-e/2,n,e);this.ctx.fillRect(t,this.h/2-e/2,o,e)}}class L{constructor(t,n){this.pos=t;this.layer=n.layer?n.layer:0;this.stage=n.stage?n.stage:void 0;this.debugColour=n.debugColour?n.debugColour:'#000000';this.remove=!1}init(){}update(t){}render(){this.debugDraw()}debugDraw(){}}class F extends L{constructor(t,n,e){super(t,e);this.r=n}debugDraw(){let t=this.stage.ctx;t.beginPath();t.fillStyle=this.debugColour;t.arc(this.pos.x,this.pos.y,this.r,0,2*Math.PI);t.fill()}}class A extends v{constructor(t,n){super(t,n)}init(){super.init();for(let t=0;t<c.r;t++){for(let n=0;n<c.c;n++){if(c.tiles[t][n]===null){continue}let e=c.tiles[t][n],o=e.c*50+30+20*(t%2),r=e.r*50+30;this.addActor(new B(new h(o,r),e))}}s.addEventListener("mousedown",n=>{let e=b(s,n),o=this.actors.filter(t=>t instanceof B).filter(t=>t.doesIntersect(e));if(o[0]!==void 0){let n=o[0].tile;t.emit("move",{r:n.r,c:n.c})}})}update(t){super.update(t)}render(){super.render()}}class B extends F{constructor(t,n){super(t,20,{layer:n.y});this.tile=n}doesIntersect(t){return y(t,this.pos)<this.r}update(t){}render(){this.tile=c.tiles[this.tile.r][this.tile.c];this.tile.owner===i?(this.debugColour="#0000FF"):this.tile.owner!==void 0?(this.debugColour="#FF0000"):(this.debugColour="#000000");super.render()}}}()